<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>HTML-DOCX test</title>
    <link rel="stylesheet" href="css/font-awesome.css">
    <link rel="stylesheet" href="css/custom.css">
    <script src="http://cdn.tinymce.com/4/tinymce.min.js"></script>
    <script src="FileSaver.js"></script>
    <script src="html-docx.js"></script>
</head>

<body>
    <div id="content" style="">
        <div style="width: 595px!important; height:800px!important; margin-bottom:10px;background-color: #00c">
            <p style="font-family: cursive;">We all live in a yellow submarine, yellow submarine, yellow submarine, yellow submarine</p>
            <p>Images can also be exported if you source them as base64 DATA URI.</p>
            <img src="cat.jpg">
            <img src="cat.jpg">
            <p style="display: inline-block;">Images can also be exported if you source them as base64 DATA URI.</p>
            <img src="cat.jpg">
        </div>
        <div style="width: 595px!important; height:800px!important;background-color: #00c">
            <p style="font-family: cursive;">We all live in a yellow submarine, yellow submarine, yellow submarine, yellow submarine</p>
            <p>Images can also be exported if you source them as base64 DATA URI.</p>
            <img src="cat.jpg">
            <img src="cat.jpg">
            <p style="display: inline-block;">Images can also be exported if you source them as base64 DATA URI.</p>
            <img src="cat.jpg">
        </div>
    </div>
    <button id="convert">Convert</button>
    <div id="download-area"></div>
    <script>
    tinymce.init({
        selector: '#content',
        menubar: false,
        toolbar: false,
        height: 850,
        plugins: ['advlist autolink lists link image charmap print preview anchor',
            'searchreplace visualblocks code fullscreen',
            'insertdatetime media table contextmenu paste code'
        ]
    });
    document.getElementById('convert').addEventListener('click', function(e) {
        e.preventDefault();
        convertImagesToBase64()
            // for demo purposes only we are using below workaround with getDoc() and manual
            // HTML string preparation instead of simple calling the .getContent(). Becasue
            // .getContent() returns HTML string of the original document and not a modified
            // one whereas getDoc() returns realtime document - exactly what we need.
        var contentDocument = tinymce.get('content').getDoc();
        var content = '<!DOCTYPE html>' + contentDocument.documentElement.outerHTML;
        var orientation = document.querySelector('.page-orientation input:checked').value;
        var converted = htmlDocx.asBlob(content, {
            orientation: orientation
        });

        saveAs(converted, 'test.docx');

        var link = document.createElement('a');
        link.href = URL.createObjectURL(converted);
        link.download = 'document.docx';
        link.appendChild(
            document.createTextNode('Click here if your download has not started automatically'));
        var downloadArea = document.getElementById('download-area');
        downloadArea.innerHTML = '';
        downloadArea.appendChild(link);
    });

    function convertImagesToBase64() {
        contentDocument = tinymce.get('content').getDoc();
        var regularImages = contentDocument.querySelectorAll("img");
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        [].forEach.call(regularImages, function(imgElement) {
            // preparing canvas for drawing
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            canvas.width = imgElement.width;
            canvas.height = imgElement.height;

            ctx.drawImage(imgElement, 0, 0);
            // by default toDataURL() produces png image, but you can also export to jpeg
            // checkout function's documentation for more details
            var dataURL = canvas.toDataURL();
            imgElement.setAttribute('src', dataURL);
        })
        canvas.remove();
    }
    </script>
</body>

</html>
